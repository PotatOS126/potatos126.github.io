import{E as t,V as e,M as i,T as o,S as n,Q as s,a,R as r,P as l,b as c,c as h,B as d,d as u,C as p,e as m,f as y,g as b,W as g,h as w,A as f,D as E,i as v,j as x,G as P}from"./three-BqKY4gtR.js";import{l as B}from"./socket.io-client-3A9clmTn.js";import{W as S,V as T,M as I,C as k,B as A,a as C,S as L}from"./cannon-es-qJLl3FcC.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const j={type:"change"},M={type:"start"},z={type:"end"},O=new r,D=new l,Y=Math.cos(70*c.DEG2RAD);class N extends t{constructor(t,r){super(),this.object=t,this.domElement=r,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new e,this.cursor=new e,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:i.ROTATE,MIDDLE:i.DOLLY,RIGHT:i.PAN},this.touches={ONE:o.ROTATE,TWO:o.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",rt),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",rt),this._domElementKeyEvents=null},this.saveState=function(){l.target0.copy(l.target),l.position0.copy(l.object.position),l.zoom0=l.object.zoom},this.reset=function(){l.target.copy(l.target0),l.object.position.copy(l.position0),l.object.zoom=l.zoom0,l.object.updateProjectionMatrix(),l.dispatchEvent(j),l.update(),h=c.NONE},this.update=function(){const i=new e,o=(new s).setFromUnitVectors(t.up,new e(0,1,0)),n=o.clone().invert(),a=new e,r=new s,b=new e,g=2*Math.PI;return function(s=null){const w=l.object.position;i.copy(w).sub(l.target),i.applyQuaternion(o),u.setFromVector3(i),l.autoRotate&&h===c.NONE&&N(function(t){return null!==t?2*Math.PI/60*l.autoRotateSpeed*t:2*Math.PI/60/60*l.autoRotateSpeed}(s)),l.enableDamping?(u.theta+=p.theta*l.dampingFactor,u.phi+=p.phi*l.dampingFactor):(u.theta+=p.theta,u.phi+=p.phi);let f=l.minAzimuthAngle,E=l.maxAzimuthAngle;isFinite(f)&&isFinite(E)&&(f<-Math.PI?f+=g:f>Math.PI&&(f-=g),E<-Math.PI?E+=g:E>Math.PI&&(E-=g),u.theta=f<=E?Math.max(f,Math.min(E,u.theta)):u.theta>(f+E)/2?Math.max(f,u.theta):Math.min(E,u.theta)),u.phi=Math.max(l.minPolarAngle,Math.min(l.maxPolarAngle,u.phi)),u.makeSafe(),!0===l.enableDamping?l.target.addScaledVector(y,l.dampingFactor):l.target.add(y),l.target.sub(l.cursor),l.target.clampLength(l.minTargetRadius,l.maxTargetRadius),l.target.add(l.cursor);let v=!1;if(l.zoomToCursor&&I||l.object.isOrthographicCamera)u.radius=V(u.radius);else{const t=u.radius;u.radius=V(u.radius*m),v=t!=u.radius}if(i.setFromSpherical(u),i.applyQuaternion(n),w.copy(l.target).add(i),l.object.lookAt(l.target),!0===l.enableDamping?(p.theta*=1-l.dampingFactor,p.phi*=1-l.dampingFactor,y.multiplyScalar(1-l.dampingFactor)):(p.set(0,0,0),y.set(0,0,0)),l.zoomToCursor&&I){let o=null;if(l.object.isPerspectiveCamera){const t=i.length();o=V(t*m);const e=t-o;l.object.position.addScaledVector(S,e),l.object.updateMatrixWorld(),v=!!e}else if(l.object.isOrthographicCamera){const t=new e(T.x,T.y,0);t.unproject(l.object);const n=l.object.zoom;l.object.zoom=Math.max(l.minZoom,Math.min(l.maxZoom,l.object.zoom/m)),l.object.updateProjectionMatrix(),v=n!==l.object.zoom;const s=new e(T.x,T.y,0);s.unproject(l.object),l.object.position.sub(s).add(t),l.object.updateMatrixWorld(),o=i.length()}else l.zoomToCursor=!1;null!==o&&(this.screenSpacePanning?l.target.set(0,0,-1).transformDirection(l.object.matrix).multiplyScalar(o).add(l.object.position):(O.origin.copy(l.object.position),O.direction.set(0,0,-1).transformDirection(l.object.matrix),Math.abs(l.object.up.dot(O.direction))<Y?t.lookAt(l.target):(D.setFromNormalAndCoplanarPoint(l.object.up,l.target),O.intersectPlane(D,l.target))))}else if(l.object.isOrthographicCamera){const t=l.object.zoom;l.object.zoom=Math.max(l.minZoom,Math.min(l.maxZoom,l.object.zoom/m)),t!==l.object.zoom&&(l.object.updateProjectionMatrix(),v=!0)}return m=1,I=!1,!!(v||a.distanceToSquared(l.object.position)>d||8*(1-r.dot(l.object.quaternion))>d||b.distanceToSquared(l.target)>d)&&(l.dispatchEvent(j),a.copy(l.object.position),r.copy(l.object.quaternion),b.copy(l.target),!0)}}(),this.dispose=function(){l.domElement.removeEventListener("contextmenu",ct),l.domElement.removeEventListener("pointerdown",et),l.domElement.removeEventListener("pointercancel",ot),l.domElement.removeEventListener("wheel",nt),l.domElement.removeEventListener("pointermove",it),l.domElement.removeEventListener("pointerup",ot);l.domElement.getRootNode().removeEventListener("keydown",st,{capture:!0}),null!==l._domElementKeyEvents&&(l._domElementKeyEvents.removeEventListener("keydown",rt),l._domElementKeyEvents=null)};const l=this,c={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let h=c.NONE;const d=1e-6,u=new n,p=new n;let m=1;const y=new e,b=new a,g=new a,w=new a,f=new a,E=new a,v=new a,x=new a,P=new a,B=new a,S=new e,T=new a;let I=!1;const k=[],A={};let C=!1;function L(t){const e=Math.abs(.01*t);return Math.pow(.95,l.zoomSpeed*e)}function N(t){p.theta-=t}function R(t){p.phi-=t}const H=function(){const t=new e;return function(e,i){t.setFromMatrixColumn(i,0),t.multiplyScalar(-e),y.add(t)}}(),F=function(){const t=new e;return function(e,i){!0===l.screenSpacePanning?t.setFromMatrixColumn(i,1):(t.setFromMatrixColumn(i,0),t.crossVectors(l.object.up,t)),t.multiplyScalar(e),y.add(t)}}(),K=function(){const t=new e;return function(e,i){const o=l.domElement;if(l.object.isPerspectiveCamera){const n=l.object.position;t.copy(n).sub(l.target);let s=t.length();s*=Math.tan(l.object.fov/2*Math.PI/180),H(2*e*s/o.clientHeight,l.object.matrix),F(2*i*s/o.clientHeight,l.object.matrix)}else l.object.isOrthographicCamera?(H(e*(l.object.right-l.object.left)/l.object.zoom/o.clientWidth,l.object.matrix),F(i*(l.object.top-l.object.bottom)/l.object.zoom/o.clientHeight,l.object.matrix)):l.enablePan=!1}}();function X(t){l.object.isPerspectiveCamera||l.object.isOrthographicCamera?m/=t:l.enableZoom=!1}function _(t){l.object.isPerspectiveCamera||l.object.isOrthographicCamera?m*=t:l.enableZoom=!1}function Z(t,e){if(!l.zoomToCursor)return;I=!0;const i=l.domElement.getBoundingClientRect(),o=t-i.left,n=e-i.top,s=i.width,a=i.height;T.x=o/s*2-1,T.y=-n/a*2+1,S.set(T.x,T.y,1).unproject(l.object).sub(l.object.position).normalize()}function V(t){return Math.max(l.minDistance,Math.min(l.maxDistance,t))}function U(t){b.set(t.clientX,t.clientY)}function q(t){f.set(t.clientX,t.clientY)}function G(t){if(1===k.length)b.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),o=.5*(t.pageY+e.y);b.set(i,o)}}function W(t){if(1===k.length)f.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),o=.5*(t.pageY+e.y);f.set(i,o)}}function $(t){const e=dt(t),i=t.pageX-e.x,o=t.pageY-e.y,n=Math.sqrt(i*i+o*o);x.set(0,n)}function Q(t){if(1==k.length)g.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),o=.5*(t.pageY+e.y);g.set(i,o)}w.subVectors(g,b).multiplyScalar(l.rotateSpeed);const e=l.domElement;N(2*Math.PI*w.x/e.clientHeight),R(2*Math.PI*w.y/e.clientHeight),b.copy(g)}function J(t){if(1===k.length)E.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),o=.5*(t.pageY+e.y);E.set(i,o)}v.subVectors(E,f).multiplyScalar(l.panSpeed),K(v.x,v.y),f.copy(E)}function tt(t){const e=dt(t),i=t.pageX-e.x,o=t.pageY-e.y,n=Math.sqrt(i*i+o*o);P.set(0,n),B.set(0,Math.pow(P.y/x.y,l.zoomSpeed)),X(B.y),x.copy(P);Z(.5*(t.pageX+e.x),.5*(t.pageY+e.y))}function et(t){!1!==l.enabled&&(0===k.length&&(l.domElement.setPointerCapture(t.pointerId),l.domElement.addEventListener("pointermove",it),l.domElement.addEventListener("pointerup",ot)),function(t){for(let e=0;e<k.length;e++)if(k[e]==t.pointerId)return!0;return!1}(t)||(function(t){k.push(t.pointerId)}(t),"touch"===t.pointerType?lt(t):function(t){let e;switch(t.button){case 0:e=l.mouseButtons.LEFT;break;case 1:e=l.mouseButtons.MIDDLE;break;case 2:e=l.mouseButtons.RIGHT;break;default:e=-1}switch(e){case i.DOLLY:if(!1===l.enableZoom)return;!function(t){Z(t.clientX,t.clientX),x.set(t.clientX,t.clientY)}(t),h=c.DOLLY;break;case i.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===l.enablePan)return;q(t),h=c.PAN}else{if(!1===l.enableRotate)return;U(t),h=c.ROTATE}break;case i.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===l.enableRotate)return;U(t),h=c.ROTATE}else{if(!1===l.enablePan)return;q(t),h=c.PAN}break;default:h=c.NONE}h!==c.NONE&&l.dispatchEvent(M)}(t)))}function it(t){!1!==l.enabled&&("touch"===t.pointerType?function(t){switch(ht(t),h){case c.TOUCH_ROTATE:if(!1===l.enableRotate)return;Q(t),l.update();break;case c.TOUCH_PAN:if(!1===l.enablePan)return;J(t),l.update();break;case c.TOUCH_DOLLY_PAN:if(!1===l.enableZoom&&!1===l.enablePan)return;!function(t){l.enableZoom&&tt(t),l.enablePan&&J(t)}(t),l.update();break;case c.TOUCH_DOLLY_ROTATE:if(!1===l.enableZoom&&!1===l.enableRotate)return;!function(t){l.enableZoom&&tt(t),l.enableRotate&&Q(t)}(t),l.update();break;default:h=c.NONE}}(t):function(t){switch(h){case c.ROTATE:if(!1===l.enableRotate)return;!function(t){g.set(t.clientX,t.clientY),w.subVectors(g,b).multiplyScalar(l.rotateSpeed);const e=l.domElement;N(2*Math.PI*w.x/e.clientHeight),R(2*Math.PI*w.y/e.clientHeight),b.copy(g),l.update()}(t);break;case c.DOLLY:if(!1===l.enableZoom)return;!function(t){P.set(t.clientX,t.clientY),B.subVectors(P,x),B.y>0?X(L(B.y)):B.y<0&&_(L(B.y)),x.copy(P),l.update()}(t);break;case c.PAN:if(!1===l.enablePan)return;!function(t){E.set(t.clientX,t.clientY),v.subVectors(E,f).multiplyScalar(l.panSpeed),K(v.x,v.y),f.copy(E),l.update()}(t)}}(t))}function ot(t){switch(function(t){delete A[t.pointerId];for(let e=0;e<k.length;e++)if(k[e]==t.pointerId)return void k.splice(e,1)}(t),k.length){case 0:l.domElement.releasePointerCapture(t.pointerId),l.domElement.removeEventListener("pointermove",it),l.domElement.removeEventListener("pointerup",ot),l.dispatchEvent(z),h=c.NONE;break;case 1:const e=k[0],i=A[e];lt({pointerId:e,pageX:i.x,pageY:i.y})}}function nt(t){!1!==l.enabled&&!1!==l.enableZoom&&h===c.NONE&&(t.preventDefault(),l.dispatchEvent(M),function(t){Z(t.clientX,t.clientY),t.deltaY<0?_(L(t.deltaY)):t.deltaY>0&&X(L(t.deltaY)),l.update()}(function(t){const e=t.deltaMode,i={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100}t.ctrlKey&&!C&&(i.deltaY*=10);return i}(t)),l.dispatchEvent(z))}function st(t){if("Control"===t.key){C=!0;l.domElement.getRootNode().addEventListener("keyup",at,{passive:!0,capture:!0})}}function at(t){if("Control"===t.key){C=!1;l.domElement.getRootNode().removeEventListener("keyup",at,{passive:!0,capture:!0})}}function rt(t){!1!==l.enabled&&!1!==l.enablePan&&function(t){let e=!1;switch(t.code){case l.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?R(2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):K(0,l.keyPanSpeed),e=!0;break;case l.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?R(-2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):K(0,-l.keyPanSpeed),e=!0;break;case l.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?N(2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):K(l.keyPanSpeed,0),e=!0;break;case l.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?N(-2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):K(-l.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),l.update())}(t)}function lt(t){switch(ht(t),k.length){case 1:switch(l.touches.ONE){case o.ROTATE:if(!1===l.enableRotate)return;G(t),h=c.TOUCH_ROTATE;break;case o.PAN:if(!1===l.enablePan)return;W(t),h=c.TOUCH_PAN;break;default:h=c.NONE}break;case 2:switch(l.touches.TWO){case o.DOLLY_PAN:if(!1===l.enableZoom&&!1===l.enablePan)return;!function(t){l.enableZoom&&$(t),l.enablePan&&W(t)}(t),h=c.TOUCH_DOLLY_PAN;break;case o.DOLLY_ROTATE:if(!1===l.enableZoom&&!1===l.enableRotate)return;!function(t){l.enableZoom&&$(t),l.enableRotate&&G(t)}(t),h=c.TOUCH_DOLLY_ROTATE;break;default:h=c.NONE}break;default:h=c.NONE}h!==c.NONE&&l.dispatchEvent(M)}function ct(t){!1!==l.enabled&&t.preventDefault()}function ht(t){let e=A[t.pointerId];void 0===e&&(e=new a,A[t.pointerId]=e),e.set(t.pageX,t.pageY)}function dt(t){const e=t.pointerId===k[0]?k[1]:k[0];return A[e]}l.domElement.addEventListener("contextmenu",ct),l.domElement.addEventListener("pointerdown",et),l.domElement.addEventListener("pointercancel",ot),l.domElement.addEventListener("wheel",nt,{passive:!1});l.domElement.getRootNode().addEventListener("keydown",st,{passive:!0,capture:!0}),this.update()}}class R{constructor(){this.world=new S({gravity:new T(0,-9.82,0)}),this.world.defaultContactMaterial.friction=.2,this.world.defaultContactMaterial.restitution=.5,this.bodies=new Map,this.setupPhysicsWorld(),this.setupKillBox(),this.whiteBallInitialPosition=null}setupPhysicsWorld(){const t=new I("table"),e=new I("ball"),i=new k(e,e,{friction:.01,restitution:.7}),o=new k(e,t,{friction:.3,restitution:.8});this.world.addContactMaterial(i),this.world.addContactMaterial(o),this.tableMaterial=t,this.ballMaterial=e}setupKillBox(){this.killBoxBounds={minX:-2,maxX:2,minY:-2,maxY:2,minZ:-2,maxZ:2}}checkBallOutOfBounds(t){const e=t.position;return e.x<this.killBoxBounds.minX||e.x>this.killBoxBounds.maxX||e.y<this.killBoxBounds.minY||e.y>this.killBoxBounds.maxY||e.z<this.killBoxBounds.minZ||e.z>this.killBoxBounds.maxZ}createTable(t){const{width:e,height:i,cushionHeight:o}=t;this.killBoxBounds={minX:-(e+.5),maxX:e+.5,minY:-2,maxY:o+1,minZ:-(i+.5),maxZ:i+.5};const n=new A({mass:0,material:this.tableMaterial,shape:new C(new T(e/2,.01,i/2))});n.position.set(0,0,0),this.world.addBody(n);const s=(t,e)=>{const i=new A({mass:0,material:this.tableMaterial,shape:new C(new T(e.x/2,o/2,e.z/2))});return i.position.copy(t),this.world.addBody(i),i};s(new T(0,o/2,-i/2),new T(e+.1,o,.1)),s(new T(0,o/2,i/2),new T(e+.1,o,.1)),s(new T(-e/2,o/2,0),new T(.1,o,i)),s(new T(e/2,o/2,0),new T(.1,o,i))}createBall(t,e,i){const o=new A({mass:.17,material:this.ballMaterial,shape:new L(i),linearDamping:.6,angularDamping:.6,allowSleep:!0,sleepSpeedLimit:.05,sleepTimeLimit:.2});return o.position.copy(e),this.world.addBody(o),this.bodies.set(t,o),0===t&&(this.whiteBallInitialPosition=e.clone()),o}hitBall(t,e,i,o){const n=this.bodies.get(t);if(n){n.wakeUp();const t=new T(i.x*e*.15,i.y*e*.15,i.z*e*.15),o=n.position.clone();n.applyImpulse(t,o)}}update(t){this.world.step(1/60,t,3),this.bodies.forEach(((t,e)=>{this.checkBallOutOfBounds(t)&&(0===e?this.whiteBallInitialPosition&&(t.position.copy(this.whiteBallInitialPosition),t.velocity.set(0,0,0),t.angularVelocity.set(0,0,0),t.wakeUp()):(this.world.removeBody(t),this.bodies.delete(e)))}))}getBallsState(){const t={};return this.bodies.forEach(((e,i)=>{t[i]={position:{x:e.position.x,y:e.position.y,z:e.position.z},velocity:{x:e.velocity.x,y:e.velocity.y,z:e.velocity.z},quaternion:{x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w}}})),t}setBallState(t,e){const i=this.bodies.get(t);i&&(i.position.set(e.position.x,e.position.y,e.position.z),i.velocity.set(e.velocity.x,e.velocity.y,e.velocity.z),i.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w))}getBallPosition(t){const e=this.bodies.get(t);return e?e.position:null}getBallVelocity(t){const e=this.bodies.get(t);return e?e.velocity:null}isBallMoving(t){const e=this.bodies.get(t);return!!e&&(e.velocity.length()>.01||e.angularVelocity.length()>.01)}areAllBallsStopped(){return Array.from(this.bodies.values()).every((t=>{const e=t.velocity.length(),i=t.angularVelocity.length();return e<.02&&i<.02}))}resetBalls(t){this.bodies.forEach(((e,i)=>{const o=t[i];o&&(e.position.set(o.x,o.y,o.z),e.velocity.set(0,0,0),e.angularVelocity.set(0,0,0),e.wakeUp(),0===i&&(this.whiteBallInitialPosition=new T(o.x,o.y,o.z)))}))}}class H{constructor(t){this.scene=t,this.balls=new Map,this.physics=new R,this.initialPositions=new Map,this.createTable(),this.createBalls(),this.physics.createTable({width:2.54,height:1.27,cushionHeight:.0635})}createTable(){const t=2.54,e=1.27,i=.0635,o=new h(new d(t,.02,e),new u({color:3497531,roughness:.8,metalness:.1}));o.receiveShadow=!0,o.position.y=0,this.scene.add(o);const n=new u({color:4865068,roughness:.6,metalness:.2}),s=new d(2.64,i,.1),a=new d(.1,i,e),r=new h(s,n);r.position.set(0,.03175,-.635),r.castShadow=!0,r.receiveShadow=!0;const l=new h(s,n);l.position.set(0,.03175,.635),l.castShadow=!0,l.receiveShadow=!0;const c=new h(a,n);c.position.set(-1.27,.03175,0),c.castShadow=!0,c.receiveShadow=!0;const p=new h(a,n);p.position.set(1.27,.03175,0),p.castShadow=!0,p.receiveShadow=!0,this.scene.add(r),this.scene.add(l),this.scene.add(c),this.scene.add(p),this.createPockets()}createPockets(){const t=new p(.06,.06,.05,32),e=new u({color:0,roughness:1,metalness:0});[{x:-1.27,z:-.635},{x:0,z:-.635},{x:1.27,z:-.635},{x:-1.27,z:.635},{x:0,z:.635},{x:1.27,z:.635}].forEach((i=>{const o=new h(t,e);o.position.set(i.x,-.02,i.z),o.rotation.x=Math.PI/2,o.receiveShadow=!0,this.scene.add(o)}))}createBalls(){const t=.029,i=new m(t,32,32);[{number:0,color:16777215,position:{x:-.635,z:0}},{number:1,color:16776960,position:{x:.635,z:0}},{number:2,color:255,position:{x:.679,z:.026}},{number:3,color:16711680,position:{x:.679,z:-.026}},{number:4,color:8388736,position:{x:.723,z:.052}},{number:5,color:16753920,position:{x:.723,z:0}},{number:6,color:32768,position:{x:.723,z:-.052}},{number:7,color:9127187,position:{x:.767,z:.078}},{number:8,color:0,position:{x:.767,z:.026}},{number:9,color:16776960,position:{x:.767,z:-.026}},{number:10,color:255,position:{x:.767,z:-.078}},{number:11,color:16711680,position:{x:.811,z:.104}},{number:12,color:8388736,position:{x:.811,z:.052}},{number:13,color:16753920,position:{x:.811,z:0}},{number:14,color:32768,position:{x:.811,z:-.052}},{number:15,color:9127187,position:{x:.811,z:-.104}}].forEach((o=>{const n=new u({color:o.color,metalness:.1,roughness:.2}),s=new h(i,n),a=new e(o.position.x,t,o.position.z);this.initialPositions.set(o.number,a.clone()),s.position.copy(a),s.castShadow=!0,s.receiveShadow=!0,s.userData={number:o.number,type:0===o.number?"cue":8===o.number?"black":o.number<8?"solid":"striped"},this.balls.set(o.number,s),this.scene.add(s),this.physics.createBall(o.number,a,t)}))}update(t){this.physics.update(t),this.balls.forEach(((t,e)=>{const i=this.physics.bodies.get(e);i?(t.position.copy(i.position),t.quaternion.copy(i.quaternion)):0!==e&&(this.scene.remove(t),this.balls.delete(e))}))}hitCueBall(t,e){this.physics.hitBall(0,t,e)}getBallPosition(t){const e=this.balls.get(t);return e?e.position.clone():null}updateBallPosition(t,e){const i=this.balls.get(t),o=this.physics.bodies.get(t);i&&o&&(i.position.copy(e),o.position.copy(e),o.velocity.set(0,0,0),o.angularVelocity.set(0,0,0))}resetBalls(){this.initialPositions.forEach(((t,e)=>{if(!this.balls.has(e)){const i=.029,o=new m(i,32,32),n=this.getBallColor(e),s=new u({color:n,metalness:.1,roughness:.2}),a=new h(o,s);a.position.copy(t),a.castShadow=!0,a.receiveShadow=!0,a.userData={number:e,type:0===e?"cue":8===e?"black":e<8?"solid":"striped"},this.balls.set(e,a),this.scene.add(a),this.physics.createBall(e,t,i)}}));const t={};this.initialPositions.forEach(((e,i)=>{t[i]={x:e.x,y:e.y,z:e.z}})),this.physics.resetBalls(t),this.balls.forEach(((t,e)=>{const i=this.initialPositions.get(e);i&&t.position.copy(i)}))}getBallColor(t){return{0:16777215,1:16776960,2:255,3:16711680,4:8388736,5:16753920,6:32768,7:9127187,8:0,9:16776960,10:255,11:16711680,12:8388736,13:16753920,14:32768,15:9127187}[t]||16777215}areAllBallsStopped(){return this.physics.areAllBallsStopped()}}new class{constructor(){this.scene=new y,this.camera=new b(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new g({antialias:!0}),this.playerId=null,this.isHoldingCue=!1,this.lastTime=0,this.isSimulating=!1,this.shotDirection=0,this.verticalAngle=0,this.hitPoint={x:0,y:0},this.shotForce=5,this.setupRenderer(),this.setupCamera(),this.setupLights(),this.setupControls(),this.setupUI(),this.setupSocket(),this.setupPoolTable(),this.setupEventListeners(),this.setupShotControls(),this.setupDirectionIndicator(),this.animate()}setupRenderer(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=w,document.getElementById("game-container").appendChild(this.renderer.domElement)}setupCamera(){this.camera.position.set(0,3,2),this.camera.lookAt(0,0,0)}setupLights(){const t=new f(16777215,.5);this.scene.add(t);const e=new E(16777215,1);e.position.set(5,5,5),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,this.scene.add(e);const i=new E(16777215,.3);i.position.set(-5,5,-5),this.scene.add(i)}setupControls(){this.controls=new N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.maxPolarAngle=Math.PI/2,this.controls.minDistance=2,this.controls.maxDistance=5}setupPoolTable(){this.poolTable=new H(this.scene),this.setupDirectionIndicator()}setupEventListeners(){window.addEventListener("resize",(()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}))}setupUI(){this.joinBtn=document.getElementById("join-btn"),this.playerInput=document.getElementById("player-input"),this.gameControls=document.getElementById("game-controls"),this.loginSection=document.getElementById("login-section"),this.cueBtn=document.getElementById("cue-btn"),this.releaseBtn=document.getElementById("release-btn"),this.resetBtn=document.getElementById("reset-btn"),this.gameStatus=document.getElementById("game-status"),this.playersList=document.getElementById("players"),this.joinBtn.addEventListener("click",(()=>this.joinGame())),this.cueBtn.addEventListener("click",(()=>this.takeCue())),this.releaseBtn.addEventListener("click",(()=>this.releaseCue())),this.resetBtn.addEventListener("click",(()=>this.resetTable()))}setupSocket(){this.socket=B("http://localhost:3000"),this.socket.on("connect",(()=>{})),this.socket.on("disconnect",(()=>{this.updateGameStatus("与服务器断开连接")})),this.socket.on("gameState",(t=>{this.updateGameState(t)})),this.socket.on("playerList",(t=>{this.updatePlayerList(t)})),this.socket.on("cueStateChanged",(t=>{this.updateCueState(t)})),this.socket.on("ballsUpdate",(t=>{t.playerId!==this.playerId&&this.poolTable&&Object.entries(t.state).forEach((([t,e])=>{this.poolTable.physics.setBallState(parseInt(t),e)}))})),this.socket.on("ballHit",(t=>{t.playerId!==this.playerId&&(this.poolTable.hitCueBall(t.force,t.direction,t.hitPoint),this.isSimulating=!0)})),this.socket.on("simulationComplete",(t=>{t.playerId!==this.playerId&&this.poolTable&&(Object.entries(t.finalState).forEach((([t,e])=>{this.poolTable.physics.setBallState(parseInt(t),e)})),this.isSimulating=!1,this.updateCueButtons(!0))}))}joinGame(){const t=this.playerInput.value.trim();t&&(this.socket.emit("joinGame",{playerId:t}),this.playerId=t,this.loginSection.style.display="none",this.gameControls.style.display="block")}takeCue(){this.socket.emit("takeCue",{playerId:this.playerId})}releaseCue(){this.socket.emit("releaseCue",{playerId:this.playerId})}resetTable(){this.socket.emit("resetTable",{playerId:this.playerId}),this.poolTable&&(this.poolTable.resetBalls(),this.isSimulating=!1)}updateGameState(t){const{currentPlayer:e,isReset:i}=t;e?(this.updateGameStatus(`当前持杆玩家: ${e}`),this.updateCueButtons(e===this.playerId)):(this.updateGameStatus("等待玩家拿起球杆"),this.updateCueButtons(!0))}updatePlayerList(t){this.playersList.innerHTML=t.map((t=>`<li>${t.id}${t.isHoldingCue?" (持杆中)":""}</li>`)).join("")}updateCueState(t){const{playerId:e,isHolding:i}=t;e===this.playerId&&(this.isHoldingCue=i,this.updateCueButtons(i),this.shotControls.style.display=i&&!this.isSimulating?"block":"none",this.directionArrow&&(this.directionArrow.visible=i&&!this.isSimulating))}updateCueButtons(t){this.cueBtn.disabled=!t||this.isHoldingCue||this.isSimulating,this.releaseBtn.disabled=!this.isHoldingCue}updateGameStatus(t){this.gameStatus.textContent=t}updateBallPositions(t){this.poolTable&&Object.entries(t).forEach((([t,e])=>{this.poolTable.updateBallPosition(parseInt(t),e)}))}setupDirectionIndicator(){if(!this.poolTable||!this.poolTable.balls)return void setTimeout((()=>this.setupDirectionIndicator()),100);const t=this.poolTable.balls.get(0);if(!t)return;const e=new v({color:5025616,transparent:!0,opacity:.7}),i=new p(.01,.01,.5,8);this.arrowBody=new h(i,e),this.arrowBody.position.y=.25;const o=new x(.03,.1,8);this.arrowHead=new h(o,e),this.arrowHead.position.y=.5,this.directionArrow=new P,this.directionArrow.add(this.arrowBody),this.directionArrow.add(this.arrowHead),this.directionArrow.position.copy(t.position),this.directionArrow.position.y+=.01,this.directionArrow.visible=!1,this.scene.add(this.directionArrow),this.updateDirectionArrow()}updateDirectionArrow(){if(!this.poolTable||!this.directionArrow)return;const t=this.poolTable.balls.get(0);if(!t)return;const i=Math.cos(this.verticalAngle),o=new e(Math.cos(this.shotDirection)*i,Math.sin(this.verticalAngle),Math.sin(this.shotDirection)*i);this.directionArrow.position.copy(t.position),this.directionArrow.position.y+=.01;const n=new e(0,1,0),a=new s;a.setFromUnitVectors(n,o),this.directionArrow.setRotationFromQuaternion(a);const r=.5+this.shotForce/10*.5;this.directionArrow.scale.set(r,r,r),this.directionArrow.visible=this.isHoldingCue&&!this.isSimulating}executeShot(){if(!this.isHoldingCue||this.isSimulating)return;const t=Math.cos(this.verticalAngle),i=new e(Math.cos(this.shotDirection)*t,Math.sin(this.verticalAngle),Math.sin(this.shotDirection)*t),o=this.shotForce;this.poolTable.hitCueBall(o,i,this.hitPoint),this.isSimulating=!0,this.directionArrow.visible=!1,this.socket.emit("ballHit",{playerId:this.playerId,force:o,direction:{x:i.x,y:i.y,z:i.z},hitPoint:this.hitPoint})}setupShotControls(){this.shotControls=document.getElementById("shot-controls"),this.directionSlider=document.getElementById("direction-slider"),this.directionValue=document.getElementById("direction-value"),this.verticalSlider=document.getElementById("vertical-slider"),this.verticalValue=document.getElementById("vertical-value"),this.hitPointControl=document.getElementById("hit-point-control"),this.hitPointHandle=document.getElementById("hit-point-handle"),this.forceSlider=document.getElementById("force-slider"),this.forceValue=document.getElementById("force-value"),this.shootButton=document.getElementById("shoot-button"),this.directionSlider.addEventListener("input",(t=>{const e=parseInt(t.target.value);this.directionValue.textContent=`${e}°`,this.shotDirection=-e*Math.PI/180,this.updateDirectionArrow()})),this.verticalSlider.addEventListener("input",(t=>{const e=parseInt(t.target.value);this.verticalValue.textContent=`${e}°`,this.verticalAngle=e*Math.PI/180,this.updateDirectionArrow()}));let t=!1;this.hitPointControl.addEventListener("mousedown",(()=>t=!0)),document.addEventListener("mouseup",(()=>t=!1)),document.addEventListener("mousemove",(e=>{if(t){const t=this.hitPointControl.getBoundingClientRect(),i=t.left+t.width/2,o=t.top+t.height/2;let n=(e.clientX-i)/(t.width/2),s=(e.clientY-o)/(t.height/2);const a=Math.sqrt(n*n+s*s);a>1&&(n/=a,s/=a),this.hitPoint={x:n,y:s},this.hitPointHandle.style.left=50+50*n+"%",this.hitPointHandle.style.top=50+50*s+"%"}})),this.forceSlider.addEventListener("input",(t=>{this.shotForce=parseFloat(t.target.value),this.forceValue.textContent=this.shotForce.toFixed(1),this.updateDirectionArrow()})),this.shootButton.addEventListener("click",(()=>this.executeShot()))}animate(t=0){requestAnimationFrame((t=>this.animate(t)));const e=(t-this.lastTime)/1e3;if(this.lastTime=t,this.poolTable&&this.isSimulating){this.poolTable.update(e);const t=this.poolTable.physics.getBallsState();this.socket.emit("ballsState",{playerId:this.playerId,state:t}),this.poolTable.areAllBallsStopped()&&(this.isSimulating=!1,this.updateCueButtons(!0),this.socket.emit("simulationComplete",{playerId:this.playerId,finalState:t}))}this.controls.update(),this.renderer.render(this.scene,this.camera)}};
