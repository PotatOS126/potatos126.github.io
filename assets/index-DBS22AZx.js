import{E as t,V as e,M as i,T as s,S as n,Q as o,a,R as r,P as l,b as c,c as h,B as d,d as p,C as u,e as m,f as y,g,h as f,W as b,i as S,A as w,D as v,j as E,k as x,G as I}from"./three-BFKwt-hE.js";import{l as C}from"./socket.io-client-3A9clmTn.js";import{W as k,V as B,N as P,M,C as T,B as L,a as D,S as A}from"./cannon-es-Cu3T84dU.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerPolicy&&(e.referrerPolicy=t.referrerPolicy),"use-credentials"===t.crossOrigin?e.credentials="include":"anonymous"===t.crossOrigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();const z={type:"change"},O={type:"start"},j={type:"end"},H=new r,F=new l,R=Math.cos(70*c.DEG2RAD);class N extends t{constructor(t,r){super(),this.object=t,this.domElement=r,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new e,this.cursor=new e,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minTargetRadius=0,this.maxTargetRadius=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.zoomToCursor=!1,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:i.ROTATE,MIDDLE:i.DOLLY,RIGHT:i.PAN},this.touches={ONE:s.ROTATE,TWO:s.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return p.phi},this.getAzimuthalAngle=function(){return p.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",rt),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",rt),this._domElementKeyEvents=null},this.saveState=function(){l.target0.copy(l.target),l.position0.copy(l.object.position),l.zoom0=l.object.zoom},this.reset=function(){l.target.copy(l.target0),l.object.position.copy(l.position0),l.object.zoom=l.zoom0,l.object.updateProjectionMatrix(),l.dispatchEvent(z),l.update(),h=c.NONE},this.update=function(){const i=new e,s=(new o).setFromUnitVectors(t.up,new e(0,1,0)),n=s.clone().invert(),a=new e,r=new o,g=new e,f=2*Math.PI;return function(o=null){const b=l.object.position;i.copy(b).sub(l.target),i.applyQuaternion(s),p.setFromVector3(i),l.autoRotate&&h===c.NONE&&D(function(t){return null!==t?2*Math.PI/60*l.autoRotateSpeed*t:2*Math.PI/60/60*l.autoRotateSpeed}(o)),l.enableDamping?(p.theta+=u.theta*l.dampingFactor,p.phi+=u.phi*l.dampingFactor):(p.theta+=u.theta,p.phi+=u.phi);let S=l.minAzimuthAngle,w=l.maxAzimuthAngle;isFinite(S)&&isFinite(w)&&(S<-Math.PI?S+=f:S>Math.PI&&(S-=f),w<-Math.PI?w+=f:w>Math.PI&&(w-=f),p.theta=S<=w?Math.max(S,Math.min(w,p.theta)):p.theta>(S+w)/2?Math.max(S,p.theta):Math.min(w,p.theta)),p.phi=Math.max(l.minPolarAngle,Math.min(l.maxPolarAngle,p.phi)),p.makeSafe(),!0===l.enableDamping?l.target.addScaledVector(y,l.dampingFactor):l.target.add(y),l.target.sub(l.cursor),l.target.clampLength(l.minTargetRadius,l.maxTargetRadius),l.target.add(l.cursor);let v=!1;if(l.zoomToCursor&&B||l.object.isOrthographicCamera)p.radius=U(p.radius);else{const t=p.radius;p.radius=U(p.radius*m),v=t!=p.radius}if(i.setFromSpherical(p),i.applyQuaternion(n),b.copy(l.target).add(i),l.object.lookAt(l.target),!0===l.enableDamping?(u.theta*=1-l.dampingFactor,u.phi*=1-l.dampingFactor,y.multiplyScalar(1-l.dampingFactor)):(u.set(0,0,0),y.set(0,0,0)),l.zoomToCursor&&B){let s=null;if(l.object.isPerspectiveCamera){const t=i.length();s=U(t*m);const e=t-s;l.object.position.addScaledVector(C,e),l.object.updateMatrixWorld(),v=!!e}else if(l.object.isOrthographicCamera){const t=new e(k.x,k.y,0);t.unproject(l.object);const n=l.object.zoom;l.object.zoom=Math.max(l.minZoom,Math.min(l.maxZoom,l.object.zoom/m)),l.object.updateProjectionMatrix(),v=n!==l.object.zoom;const o=new e(k.x,k.y,0);o.unproject(l.object),l.object.position.sub(o).add(t),l.object.updateMatrixWorld(),s=i.length()}else l.zoomToCursor=!1;null!==s&&(this.screenSpacePanning?l.target.set(0,0,-1).transformDirection(l.object.matrix).multiplyScalar(s).add(l.object.position):(H.origin.copy(l.object.position),H.direction.set(0,0,-1).transformDirection(l.object.matrix),Math.abs(l.object.up.dot(H.direction))<R?t.lookAt(l.target):(F.setFromNormalAndCoplanarPoint(l.object.up,l.target),H.intersectPlane(F,l.target))))}else if(l.object.isOrthographicCamera){const t=l.object.zoom;l.object.zoom=Math.max(l.minZoom,Math.min(l.maxZoom,l.object.zoom/m)),t!==l.object.zoom&&(l.object.updateProjectionMatrix(),v=!0)}return m=1,B=!1,!!(v||a.distanceToSquared(l.object.position)>d||8*(1-r.dot(l.object.quaternion))>d||g.distanceToSquared(l.target)>d)&&(l.dispatchEvent(z),a.copy(l.object.position),r.copy(l.object.quaternion),g.copy(l.target),!0)}}(),this.dispose=function(){l.domElement.removeEventListener("contextmenu",ct),l.domElement.removeEventListener("pointerdown",et),l.domElement.removeEventListener("pointercancel",st),l.domElement.removeEventListener("wheel",nt),l.domElement.removeEventListener("pointermove",it),l.domElement.removeEventListener("pointerup",st);l.domElement.getRootNode().removeEventListener("keydown",ot,{capture:!0}),null!==l._domElementKeyEvents&&(l._domElementKeyEvents.removeEventListener("keydown",rt),l._domElementKeyEvents=null)};const l=this,c={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let h=c.NONE;const d=1e-6,p=new n,u=new n;let m=1;const y=new e,g=new a,f=new a,b=new a,S=new a,w=new a,v=new a,E=new a,x=new a,I=new a,C=new e,k=new a;let B=!1;const P=[],M={};let T=!1;function L(t){const e=Math.abs(.01*t);return Math.pow(.95,l.zoomSpeed*e)}function D(t){u.theta-=t}function A(t){u.phi-=t}const N=function(){const t=new e;return function(e,i){t.setFromMatrixColumn(i,0),t.multiplyScalar(-e),y.add(t)}}(),q=function(){const t=new e;return function(e,i){!0===l.screenSpacePanning?t.setFromMatrixColumn(i,1):(t.setFromMatrixColumn(i,0),t.crossVectors(l.object.up,t)),t.multiplyScalar(e),y.add(t)}}(),Y=function(){const t=new e;return function(e,i){const s=l.domElement;if(l.object.isPerspectiveCamera){const n=l.object.position;t.copy(n).sub(l.target);let o=t.length();o*=Math.tan(l.object.fov/2*Math.PI/180),N(2*e*o/s.clientHeight,l.object.matrix),q(2*i*o/s.clientHeight,l.object.matrix)}else l.object.isOrthographicCamera?(N(e*(l.object.right-l.object.left)/l.object.zoom/s.clientWidth,l.object.matrix),q(i*(l.object.top-l.object.bottom)/l.object.zoom/s.clientHeight,l.object.matrix)):l.enablePan=!1}}();function G(t){l.object.isPerspectiveCamera||l.object.isOrthographicCamera?m/=t:l.enableZoom=!1}function X(t){l.object.isPerspectiveCamera||l.object.isOrthographicCamera?m*=t:l.enableZoom=!1}function V(t,e){if(!l.zoomToCursor)return;B=!0;const i=l.domElement.getBoundingClientRect(),s=t-i.left,n=e-i.top,o=i.width,a=i.height;k.x=s/o*2-1,k.y=-n/a*2+1,C.set(k.x,k.y,1).unproject(l.object).sub(l.object.position).normalize()}function U(t){return Math.max(l.minDistance,Math.min(l.maxDistance,t))}function K(t){g.set(t.clientX,t.clientY)}function Z(t){S.set(t.clientX,t.clientY)}function $(t){if(1===P.length)g.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);g.set(i,s)}}function _(t){if(1===P.length)S.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);S.set(i,s)}}function W(t){const e=dt(t),i=t.pageX-e.x,s=t.pageY-e.y,n=Math.sqrt(i*i+s*s);E.set(0,n)}function J(t){if(1==P.length)f.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);f.set(i,s)}b.subVectors(f,g).multiplyScalar(l.rotateSpeed);const e=l.domElement;D(2*Math.PI*b.x/e.clientHeight),A(2*Math.PI*b.y/e.clientHeight),g.copy(f)}function Q(t){if(1===P.length)w.set(t.pageX,t.pageY);else{const e=dt(t),i=.5*(t.pageX+e.x),s=.5*(t.pageY+e.y);w.set(i,s)}v.subVectors(w,S).multiplyScalar(l.panSpeed),Y(v.x,v.y),S.copy(w)}function tt(t){const e=dt(t),i=t.pageX-e.x,s=t.pageY-e.y,n=Math.sqrt(i*i+s*s);x.set(0,n),I.set(0,Math.pow(x.y/E.y,l.zoomSpeed)),G(I.y),E.copy(x);V(.5*(t.pageX+e.x),.5*(t.pageY+e.y))}function et(t){!1!==l.enabled&&(0===P.length&&(l.domElement.setPointerCapture(t.pointerId),l.domElement.addEventListener("pointermove",it),l.domElement.addEventListener("pointerup",st)),function(t){for(let e=0;e<P.length;e++)if(P[e]==t.pointerId)return!0;return!1}(t)||(function(t){P.push(t.pointerId)}(t),"touch"===t.pointerType?lt(t):function(t){let e;switch(t.button){case 0:e=l.mouseButtons.LEFT;break;case 1:e=l.mouseButtons.MIDDLE;break;case 2:e=l.mouseButtons.RIGHT;break;default:e=-1}switch(e){case i.DOLLY:if(!1===l.enableZoom)return;!function(t){V(t.clientX,t.clientX),E.set(t.clientX,t.clientY)}(t),h=c.DOLLY;break;case i.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===l.enablePan)return;Z(t),h=c.PAN}else{if(!1===l.enableRotate)return;K(t),h=c.ROTATE}break;case i.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(!1===l.enableRotate)return;K(t),h=c.ROTATE}else{if(!1===l.enablePan)return;Z(t),h=c.PAN}break;default:h=c.NONE}h!==c.NONE&&l.dispatchEvent(O)}(t)))}function it(t){!1!==l.enabled&&("touch"===t.pointerType?function(t){switch(ht(t),h){case c.TOUCH_ROTATE:if(!1===l.enableRotate)return;J(t),l.update();break;case c.TOUCH_PAN:if(!1===l.enablePan)return;Q(t),l.update();break;case c.TOUCH_DOLLY_PAN:if(!1===l.enableZoom&&!1===l.enablePan)return;!function(t){l.enableZoom&&tt(t),l.enablePan&&Q(t)}(t),l.update();break;case c.TOUCH_DOLLY_ROTATE:if(!1===l.enableZoom&&!1===l.enableRotate)return;!function(t){l.enableZoom&&tt(t),l.enableRotate&&J(t)}(t),l.update();break;default:h=c.NONE}}(t):function(t){switch(h){case c.ROTATE:if(!1===l.enableRotate)return;!function(t){f.set(t.clientX,t.clientY),b.subVectors(f,g).multiplyScalar(l.rotateSpeed);const e=l.domElement;D(2*Math.PI*b.x/e.clientHeight),A(2*Math.PI*b.y/e.clientHeight),g.copy(f),l.update()}(t);break;case c.DOLLY:if(!1===l.enableZoom)return;!function(t){x.set(t.clientX,t.clientY),I.subVectors(x,E),I.y>0?G(L(I.y)):I.y<0&&X(L(I.y)),E.copy(x),l.update()}(t);break;case c.PAN:if(!1===l.enablePan)return;!function(t){w.set(t.clientX,t.clientY),v.subVectors(w,S).multiplyScalar(l.panSpeed),Y(v.x,v.y),S.copy(w),l.update()}(t)}}(t))}function st(t){switch(function(t){delete M[t.pointerId];for(let e=0;e<P.length;e++)if(P[e]==t.pointerId)return void P.splice(e,1)}(t),P.length){case 0:l.domElement.releasePointerCapture(t.pointerId),l.domElement.removeEventListener("pointermove",it),l.domElement.removeEventListener("pointerup",st),l.dispatchEvent(j),h=c.NONE;break;case 1:const e=P[0],i=M[e];lt({pointerId:e,pageX:i.x,pageY:i.y})}}function nt(t){!1!==l.enabled&&!1!==l.enableZoom&&h===c.NONE&&(t.preventDefault(),l.dispatchEvent(O),function(t){V(t.clientX,t.clientY),t.deltaY<0?X(L(t.deltaY)):t.deltaY>0&&G(L(t.deltaY)),l.update()}(function(t){const e=t.deltaMode,i={clientX:t.clientX,clientY:t.clientY,deltaY:t.deltaY};switch(e){case 1:i.deltaY*=16;break;case 2:i.deltaY*=100}t.ctrlKey&&!T&&(i.deltaY*=10);return i}(t)),l.dispatchEvent(j))}function ot(t){if("Control"===t.key){T=!0;l.domElement.getRootNode().addEventListener("keyup",at,{passive:!0,capture:!0})}}function at(t){if("Control"===t.key){T=!1;l.domElement.getRootNode().removeEventListener("keyup",at,{passive:!0,capture:!0})}}function rt(t){!1!==l.enabled&&!1!==l.enablePan&&function(t){let e=!1;switch(t.code){case l.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?A(2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):Y(0,l.keyPanSpeed),e=!0;break;case l.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?A(-2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):Y(0,-l.keyPanSpeed),e=!0;break;case l.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?D(2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):Y(l.keyPanSpeed,0),e=!0;break;case l.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?D(-2*Math.PI*l.rotateSpeed/l.domElement.clientHeight):Y(-l.keyPanSpeed,0),e=!0}e&&(t.preventDefault(),l.update())}(t)}function lt(t){switch(ht(t),P.length){case 1:switch(l.touches.ONE){case s.ROTATE:if(!1===l.enableRotate)return;$(t),h=c.TOUCH_ROTATE;break;case s.PAN:if(!1===l.enablePan)return;_(t),h=c.TOUCH_PAN;break;default:h=c.NONE}break;case 2:switch(l.touches.TWO){case s.DOLLY_PAN:if(!1===l.enableZoom&&!1===l.enablePan)return;!function(t){l.enableZoom&&W(t),l.enablePan&&_(t)}(t),h=c.TOUCH_DOLLY_PAN;break;case s.DOLLY_ROTATE:if(!1===l.enableZoom&&!1===l.enableRotate)return;!function(t){l.enableZoom&&W(t),l.enableRotate&&$(t)}(t),h=c.TOUCH_DOLLY_ROTATE;break;default:h=c.NONE}break;default:h=c.NONE}h!==c.NONE&&l.dispatchEvent(O)}function ct(t){!1!==l.enabled&&t.preventDefault()}function ht(t){let e=M[t.pointerId];void 0===e&&(e=new a,M[t.pointerId]=e),e.set(t.pageX,t.pageY)}function dt(t){const e=t.pointerId===P[0]?P[1]:P[0];return M[e]}l.domElement.addEventListener("contextmenu",ct),l.domElement.addEventListener("pointerdown",et),l.domElement.addEventListener("pointercancel",st),l.domElement.addEventListener("wheel",nt,{passive:!1});l.domElement.getRootNode().addEventListener("keydown",ot,{passive:!0,capture:!0}),this.update()}}const q={timeStep:1/60,maxSubSteps:3,gravity:-9.82,ccd:{enable:!1,speedThreshold:1,iterations:10,tolerance:.001,minSpeedThreshold:.5,maxSpeedThreshold:10},materials:{ball:{friction:.01,restitution:.7,contactEquationStiffness:1e8,contactEquationRelaxation:3,frictionEquationStiffness:1e8,frictionEquationRelaxation:3},table:{friction:.3,restitution:.8,contactEquationStiffness:1e8,contactEquationRelaxation:3,frictionEquationStiffness:1e8,frictionEquationRelaxation:3}},ball:{mass:.17,radius:.029,linearDamping:.5,angularDamping:.5,sleepSpeedLimit:.02,sleepTimeLimit:.1},solver:{iterations:15,tolerance:1e-5}};class Y{constructor(){this.config=q,this.world=new k({gravity:new B(0,q.gravity,0)}),this.world.solver.iterations=q.solver.iterations,this.world.solver.tolerance=q.solver.tolerance,this.setupCCD(),this.world.allowSleep=!0,this.world.broadphase=new P,this.bodies=new Map,this.pocketPositions=[],this.pocketRadius=.065,this.setupPhysicsWorld(),this.setupKillBox(),this.whiteBallInitialPosition=null}setupCCD(){const t=this.config.ccd;t.enable&&(this.ccdEnabled=!0,this.ccdConfig=t,this.dynamicSubSteps=!1)}setupPhysicsWorld(){const t=new M("table"),e=new M("ball"),i=this.config.materials.ball,s=this.config.materials.table,n=new T(e,e,{friction:i.friction,restitution:i.restitution,contactEquationStiffness:i.contactEquationStiffness,contactEquationRelaxation:i.contactEquationRelaxation,frictionEquationStiffness:i.frictionEquationStiffness,frictionEquationRelaxation:i.frictionEquationRelaxation}),o=new T(e,t,{friction:s.friction,restitution:s.restitution,contactEquationStiffness:s.contactEquationStiffness,contactEquationRelaxation:s.contactEquationRelaxation,frictionEquationStiffness:s.frictionEquationStiffness,frictionEquationRelaxation:s.frictionEquationRelaxation});this.world.addContactMaterial(n),this.world.addContactMaterial(o),this.tableMaterial=t,this.ballMaterial=e}setupKillBox(){this.killBoxBounds={minX:-2,maxX:2,minY:-2,maxY:2,minZ:-2,maxZ:2}}checkBallOutOfBounds(t){const e=t.position;return e.x<this.killBoxBounds.minX||e.x>this.killBoxBounds.maxX||e.y<this.killBoxBounds.minY||e.y>this.killBoxBounds.maxY||e.z<this.killBoxBounds.minZ||e.z>this.killBoxBounds.maxZ}createTable(t){const{width:e,height:i,cushionHeight:s}=t;this.killBoxBounds={minX:-(e+.5),maxX:e+.5,minY:-2,maxY:s+1,minZ:-(i+.5),maxZ:i+.5},this.pocketPositions=[{x:-e/2+.08,z:-i/2+.08,type:"corner"},{x:e/2-.08,z:-i/2+.08,type:"corner"},{x:-e/2+.08,z:i/2-.08,type:"corner"},{x:e/2-.08,z:i/2-.08,type:"corner"},{x:0,z:-i/2+.05,type:"side"},{x:0,z:i/2-.05,type:"side"}],this.pocketBodies=[],this.pocketPositions.forEach(((t,e)=>{t.index=e}));const n=new L({mass:0,material:this.tableMaterial,shape:new D(new B(e/2,.01,i/2))});n.position.set(0,0,0),this.world.addBody(n);const o=(t,e)=>{const i=new L({mass:0,material:this.tableMaterial,shape:new D(new B(e.x/2,s/2,e.z/2))});return i.position.copy(t),this.world.addBody(i),i};o(new B(0,s/2,-i/2),new B(e+.1,s,.1)),o(new B(0,s/2,i/2),new B(e+.1,s,.1)),o(new B(-e/2,s/2,0),new B(.1,s,i)),o(new B(e/2,s/2,0),new B(.1,s,i))}createBall(t,e,i){const s=this.config.ball,n=new L({mass:s.mass,material:this.ballMaterial,shape:new A(s.radius),linearDamping:s.linearDamping,angularDamping:s.angularDamping,allowSleep:!0,sleepSpeedLimit:s.sleepSpeedLimit,sleepTimeLimit:s.sleepTimeLimit});if(this.ccdEnabled){const t=this.ccdConfig;n.ccdSpeedThreshold=t.speedThreshold,n.ccdIterations=t.iterations,n.isCCDEnabled=!0}return n.position.copy(e),this.world.addBody(n),this.bodies.set(t,n),0===t&&(this.whiteBallInitialPosition=e.clone()),n}hitBall(t,e,i,s={x:0,y:0}){const n=this.bodies.get(t);if(!n)return;let o;n.wakeUp(),o=n.shape&&n.shape.radius?n.shape.radius:this.config.ball.radius;const a=s.x*o*.8,r=-s.y*o*.8,l=0,c=new B(i.x*e*.15,i.y*e*.15,i.z*e*.15),h=new B(n.position.x+a,n.position.y+r,n.position.z+l);n.applyImpulse(c,h);const d=new B(s.y*i.x*e*2*.1,s.x*e*2*.1,s.y*i.z*e*2*.1);n.angularVelocity.x+=d.x,n.angularVelocity.y+=d.y,n.angularVelocity.z+=d.z;const p=Math.abs(s.x)<.1&&Math.abs(s.y)<.1;let u="正中心";if(!p){const t=[];s.y>.3?t.push("下旋"):s.y<-.3&&t.push("上旋"),s.x>.3?t.push("右旋"):s.x<-.3&&t.push("左旋"),u=t.length>0?t.join("+"):"轻微偏移"}this.ccdEnabled}update(t){let e=!1,i=0;this.ccdEnabled&&this.bodies.forEach(((t,s)=>{const n=t.velocity.length();if(i=Math.max(i,n),n>this.ccdConfig.speedThreshold){if(e=!0,t.needsCCD=!0,n>this.ccdConfig.maxSpeedThreshold){const e=this.ccdConfig.maxSpeedThreshold/n;t.velocity.x*=e,t.velocity.y*=e,t.velocity.z*=e}}else t.needsCCD=!1}));let s=this.config.timeStep,n=this.config.maxSubSteps;e&&(s=.8*this.config.timeStep,n=Math.min(this.config.maxSubSteps+2,6)),this.world.step(s,t,n),e&&this.performCCDCorrection();const o=this.checkPocketCollisions(),a=[];return this.bodies.forEach(((t,e)=>{this.checkBallOutOfBounds(t)&&(a.push(e),0===e?(this.world.removeBody(t),this.bodies.delete(e)):(t.velocity.set(0,0,0),t.angularVelocity.set(0,0,0),t.position.y=-10))})),{pocketedBalls:o,outOfBoundsBalls:a.filter((t=>0!==t)),cueBallOutOfBounds:a.includes(0)}}performCCDCorrection(){if(!this.ccdEnabled)return;const t=this.ccdConfig;let e=0;const i=Array.from(this.bodies.values());for(let s=0;s<i.length;s++)for(let n=s+1;n<i.length;n++){const o=i[s],a=i[n];if(!o.needsCCD&&!a.needsCCD)continue;const r=o.position.distanceTo(a.position),l=o.shape.radius+a.shape.radius+t.tolerance;if(r<l&&r>.001){const i=l-r;if(i>t.tolerance&&e<10){const t=a.position.x-o.position.x,s=a.position.y-o.position.y,n=a.position.z-o.position.z,r=Math.sqrt(t*t+s*s+n*n);if(r<.001)continue;const l=t/r,c=s/r,h=n/r,d=.5*i;o.position.x-=l*d,o.position.y-=c*d,o.position.z-=h*d,a.position.x+=l*d,a.position.y+=c*d,a.position.z+=h*d,e++}}}this.bodies.forEach(((i,s)=>{if(!i.needsCCD)return;const n=i.position,o=i.shape.radius,a=this.killBoxBounds;let r=!1;n.x-o<a.minX&&(i.position.x=a.minX+o+t.tolerance,i.velocity.x=.8*Math.abs(i.velocity.x),r=!0),n.x+o>a.maxX&&(i.position.x=a.maxX-o-t.tolerance,i.velocity.x=.8*-Math.abs(i.velocity.x),r=!0),n.z-o<a.minZ&&(i.position.z=a.minZ+o+t.tolerance,i.velocity.z=.8*Math.abs(i.velocity.z),r=!0),n.z+o>a.maxZ&&(i.position.z=a.maxZ-o-t.tolerance,i.velocity.z=.8*-Math.abs(i.velocity.z),r=!0),r&&e++}))}getBallsState(){const t={};return this.bodies.forEach(((e,i)=>{t[i]={position:{x:e.position.x,y:e.position.y,z:e.position.z},velocity:{x:e.velocity.x,y:e.velocity.y,z:e.velocity.z},quaternion:{x:e.quaternion.x,y:e.quaternion.y,z:e.quaternion.z,w:e.quaternion.w}}})),t}setBallState(t,e){const i=this.bodies.get(t);i&&(i.position.set(e.position.x,e.position.y,e.position.z),i.velocity.set(e.velocity.x,e.velocity.y,e.velocity.z),i.quaternion.set(e.quaternion.x,e.quaternion.y,e.quaternion.z,e.quaternion.w))}getBallPosition(t){const e=this.bodies.get(t);return e?e.position:null}getBallVelocity(t){const e=this.bodies.get(t);return e?e.velocity:null}isBallMoving(t){const e=this.bodies.get(t);return!!e&&(e.velocity.length()>.01||e.angularVelocity.length()>.01)}areAllBallsStopped(){return Array.from(this.bodies.values()).every((t=>{const e=t.velocity.length(),i=t.angularVelocity.length();return e<.01&&i<.01}))}resetBalls(t){this.bodies.forEach(((e,i)=>{const s=t[i];s&&(e.position.set(s.x,s.y,s.z),e.velocity.set(0,0,0),e.angularVelocity.set(0,0,0),e.wakeUp(),0===i&&(this.whiteBallInitialPosition=new B(s.x,s.y,s.z)))}))}getCCDStatus(){if(!this.ccdEnabled)return{enabled:!1};let t=0,e=0,i=0,s=0;return this.bodies.forEach(((i,n)=>{const o=i.velocity.length();s+=o,e=Math.max(e,o),o>this.ccdConfig.speedThreshold&&t++})),i=this.bodies.size>0?s/this.bodies.size:0,{enabled:!0,config:this.ccdConfig,stats:{totalBalls:this.bodies.size,highSpeedBalls:t,maxSpeed:Math.round(100*e)/100,avgSpeed:Math.round(100*i)/100,speedThreshold:this.ccdConfig.speedThreshold}}}updateCCDConfig(t){if(!this.ccdEnabled)return!1;this.ccdConfig;return this.ccdConfig={...this.ccdConfig,...t},!0}toggleCCD(t=null){return null===t&&(t=!this.ccdEnabled),this.ccdEnabled=t,this.ccdEnabled}checkPocketCollisions(){const t=[],e=this.config.ball.radius,i=.01+e,s=i-.02,n=i+.02;return this.pocketPositions.forEach(((i,o)=>{this.bodies.forEach(((a,r)=>{const l=a.position,c=a.shape&&a.shape.radius?a.shape.radius:e,h=Math.sqrt(Math.pow(l.x-i.x,2)+Math.pow(l.z-i.z,2)),d=l.y>=s&&l.y<=n,p=h<=this.pocketRadius-.2*c,u=a.velocity.length();d&&p&&u<2&&(t.push({ballNumber:r,pocketIndex:o,pocketType:i.type}),this.world.removeBody(a),this.bodies.delete(r))}))})),t}resetOutOfBoundsBalls(t,e){t.forEach((t=>{const i=e[t];if(i){const e=new L({mass:this.config.ball.mass,material:this.ballMaterial,shape:new A(this.config.ball.radius),linearDamping:this.config.ball.linearDamping,angularDamping:this.config.ball.angularDamping,allowSleep:!0,sleepSpeedLimit:this.config.ball.sleepSpeedLimit,sleepTimeLimit:this.config.ball.sleepTimeLimit});e.position.set(i.x,i.y,i.z),e.velocity.set(0,0,0),e.angularVelocity.set(0,0,0),this.world.addBody(e),this.bodies.set(t,e)}}))}resetCueBallToPocket(){if(!this.bodies.get(0)&&this.whiteBallInitialPosition){const t=new L({mass:this.config.ball.mass,material:this.ballMaterial,shape:new A(this.config.ball.radius),linearDamping:this.config.ball.linearDamping,angularDamping:this.config.ball.angularDamping,allowSleep:!0,sleepSpeedLimit:this.config.ball.sleepSpeedLimit,sleepTimeLimit:this.config.ball.sleepTimeLimit});return t.position.copy(this.whiteBallInitialPosition),t.velocity.set(0,0,0),t.angularVelocity.set(0,0,0),this.world.addBody(t),this.bodies.set(0,t),!0}return!1}}class G{constructor(t){this.scene=t,this.balls=new Map,this.physics=new Y,this.initialPositions=new Map,this.createTable(),this.createBalls(),this.physics.createTable({width:2.54,height:1.27,cushionHeight:.0635})}createTable(){const t=2.54,e=1.27,i=.0635,s=new h(new d(t,.02,e),new p({color:3497531,roughness:.8,metalness:.1}));s.receiveShadow=!0,s.position.y=0,this.scene.add(s);const n=new p({color:4865068,roughness:.6,metalness:.2}),o=new d(2.64,i,.1),a=new d(.1,i,e),r=new h(o,n);r.position.set(0,.03175,-.635),r.castShadow=!0,r.receiveShadow=!0;const l=new h(o,n);l.position.set(0,.03175,.635),l.castShadow=!0,l.receiveShadow=!0;const c=new h(a,n);c.position.set(-1.27,.03175,0),c.castShadow=!0,c.receiveShadow=!0;const u=new h(a,n);u.position.set(1.27,.03175,0),u.castShadow=!0,u.receiveShadow=!0,this.scene.add(r),this.scene.add(l),this.scene.add(c),this.scene.add(u),this.createPockets()}createPockets(){const t=.065,e=new u(t,.0195,.035,32),i=new m(.075,.008,8,32),s=new p({color:0,roughness:1,metalness:0}),n=new p({color:2889744,roughness:.8,metalness:.1});[{x:-1.19,z:-.555,type:"corner"},{x:1.19,z:-.555,type:"corner"},{x:-1.19,z:.555,type:"corner"},{x:1.19,z:.555,type:"corner"},{x:0,z:-.585,type:"side"},{x:0,z:.585,type:"side"}].forEach(((o,a)=>{const r=new h(e.clone(),s.clone());r.position.set(o.x,.02-.0175,o.z),r.receiveShadow=!0;const l=new h(i.clone(),n.clone());if(l.position.set(o.x,.015,o.z),l.rotation.x=-Math.PI/2,l.castShadow=!0,l.receiveShadow=!0,"corner"===o.type){const e=new u(.4*t,.00975,.035*1.8,16),i=new p({color:657930,roughness:.9,metalness:0,transparent:!0,opacity:.6}),s=new h(e,i);s.position.set(o.x,-.035-.02,o.z),this.scene.add(s)}this.scene.add(r),this.scene.add(l),r.userData={type:"pocket",position:o,index:a,radius:t}}))}createBalls(){const t=.029,i=new y(t,32,32),s=.059,n={0:16777215,1:16776960,2:255,3:16711680,4:8388736,5:16753920,6:32768,7:9127187,8:0,9:16776960,10:255,11:16711680,12:8388736,13:16753920,14:32768,15:9127187},o=[];o.push({number:0,color:n[0],position:{x:-.635,z:0}}),[[1],[2,3],[4,8,5],[6,7,9,10],[11,12,13,14,15]].forEach(((t,e)=>{const i=.635+e*s*Math.sqrt(3)/2,a=-(t.length-1)*s/2;t.forEach(((t,e)=>{const r=a+e*s;o.push({number:t,color:n[t],position:{x:i,z:r}})}))})),o.forEach((s=>{const n=new p({color:s.color,metalness:.1,roughness:.2}),o=new h(i,n),a=new e(s.position.x,t,s.position.z);this.initialPositions.set(s.number,a.clone()),o.position.copy(a),o.castShadow=!0,o.receiveShadow=!0,o.userData={number:s.number,type:0===s.number?"cue":8===s.number?"black":s.number<8?"solid":"striped"},this.balls.set(s.number,o),this.scene.add(o),this.physics.createBall(s.number,a,t)}))}update(t){const e=this.physics.update(t);return this.balls.forEach(((t,e)=>{const i=this.physics.bodies.get(e);i?(t.position.copy(i.position),t.quaternion.copy(i.quaternion),t.visible=!0):0===e?t.visible=!1:(this.scene.remove(t),this.balls.delete(e))})),e}hitCueBall(t,e,i={x:0,y:0}){this.physics.hitBall(0,t,e,i)}getBallPosition(t){const e=this.balls.get(t);return e?e.position.clone():null}updateBallPosition(t,e){const i=this.balls.get(t),s=this.physics.bodies.get(t);i&&s&&(i.position.copy(e),s.position.copy(e),s.velocity.set(0,0,0),s.angularVelocity.set(0,0,0))}resetBalls(){this.initialPositions.forEach(((t,e)=>{if(!this.balls.has(e)){const i=.029,s=new y(i,32,32),n=this.getBallColor(e),o=new p({color:n,metalness:.1,roughness:.2}),a=new h(s,o);a.position.copy(t),a.castShadow=!0,a.receiveShadow=!0,a.userData={number:e,type:0===e?"cue":8===e?"black":e<8?"solid":"striped"},this.balls.set(e,a),this.scene.add(a),this.physics.createBall(e,t,i)}}));const t={};this.initialPositions.forEach(((e,i)=>{t[i]={x:e.x,y:e.y,z:e.z}})),this.physics.resetBalls(t),this.balls.forEach(((t,e)=>{const i=this.initialPositions.get(e);i&&t.position.copy(i)}))}getBallColor(t){return{0:16777215,1:16776960,2:255,3:16711680,4:8388736,5:16753920,6:32768,7:9127187,8:0,9:16776960,10:255,11:16711680,12:8388736,13:16753920,14:32768,15:9127187}[t]||16777215}areAllBallsStopped(){return this.physics.areAllBallsStopped()}handleCueBallPocketed(){const t=this.balls.get(0);if(t){const e=this.initialPositions.get(0);e&&(t.position.copy(e),t.visible=!0)}else{const t=new y(.029,32,32),e=new p({color:16777215,metalness:.1,roughness:.2}),i=new h(t,e),s=this.initialPositions.get(0);s&&(i.position.copy(s),i.castShadow=!0,i.receiveShadow=!0,i.visible=!0,i.userData={number:0,type:"cue"},this.balls.set(0,i),this.scene.add(i))}return this.physics.resetCueBallToPocket()}resetOutOfBoundsBalls(t){const e={};t.forEach((t=>{const i=this.initialPositions.get(t);if(i&&(e[t]={x:i.x,y:i.y,z:i.z},!this.balls.has(t))){const e=new y(.029,32,32),s=this.getBallColor(t),n=new p({color:s,metalness:.1,roughness:.2}),o=new h(e,n);o.position.copy(i),o.castShadow=!0,o.receiveShadow=!0,o.userData={number:t,type:8===t?"black":t<8?"solid":"striped"},this.balls.set(t,o),this.scene.add(o)}})),this.physics.resetOutOfBoundsBalls(t,e)}}const X=new class{constructor(){this.isProduction=this.detectEnvironment(),this.serverConfig={development:{socketUrl:"http://localhost:3000",apiUrl:"http://localhost:3000"},production:{socketUrl:"https://incredipoolserver.onrender.com",apiUrl:"https://incredipoolserver.onrender.com"}}}detectEnvironment(){return!0}getSocketUrl(){return(this.isProduction?this.serverConfig.production:this.serverConfig.development).socketUrl}getApiUrl(){return(this.isProduction?this.serverConfig.production:this.serverConfig.development).apiUrl}isLocalDevelopment(){return!this.isProduction}getEnvironmentInfo(){return{isProduction:this.isProduction,hostname:window.location.hostname,port:window.location.port,origin:window.location.origin,socketUrl:this.getSocketUrl(),apiUrl:this.getApiUrl(),viteMode:"production",viteDev:!1,viteProd:!0}}};X.isLocalDevelopment();new class{constructor(){this.scene=new g,this.camera=new f(75,window.innerWidth/window.innerHeight,.1,1e3),this.renderer=new b({antialias:!0}),this.playerId=null,this.isHoldingCue=!1,this.lastTime=0,this.isSimulating=!1,this.heartbeatInterval=null,this.isJoining=!1,this.networkStats={shotStartLatency:[],syncLatency:[],dataSize:{shotStart:0,syncConfirm:0},packetCount:{sent:0,received:0}},this.latencyStats={current:0,average:0,samples:[],lastPingTime:0},this.shotDirection=0,this.verticalAngle=0,this.hitPoint={x:0,y:0},this.shotForce=5,this.playerScores=new Map,this.pendingOutOfBounds=[],this.pendingCueBallReset=!1,this.currentPlayers=[],this.setupRenderer(),this.setupCamera(),this.setupLights(),this.setupControls(),this.setupUI(),this.setupSocket(),this.setupPoolTable(),this.setupEventListeners(),this.setupShotControls(),this.setupDirectionIndicator(),this.updateGameStateIndicator("connecting","正在连接服务器..."),this.animate()}setupRenderer(){this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=S,document.getElementById("game-container").appendChild(this.renderer.domElement)}setupCamera(){this.camera.position.set(0,3,2),this.camera.lookAt(0,0,0)}setupLights(){const t=new w(16777215,.5);this.scene.add(t);const e=new v(16777215,1);e.position.set(5,5,5),e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,this.scene.add(e);const i=new v(16777215,.3);i.position.set(-5,5,-5),this.scene.add(i)}setupControls(){this.controls=new N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.maxPolarAngle=Math.PI/2,this.controls.minDistance=2,this.controls.maxDistance=5}setupPoolTable(){this.poolTable=new G(this.scene),this.setupDirectionIndicator()}setupEventListeners(){window.addEventListener("resize",(()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)})),window.addEventListener("beforeunload",(()=>{this.clearHeartbeat(),this.socket&&this.socket.connected&&this.playerId&&this.socket.disconnect()})),document.addEventListener("visibilitychange",(()=>{!document.hidden&&this.socket&&this.socket.connected&&this.playerId&&this.socket.emit("heartbeat",{playerId:this.playerId})}))}setupUI(){this.joinBtn=document.getElementById("join-btn"),this.playerInput=document.getElementById("player-input"),this.gameControls=document.getElementById("game-controls"),this.loginSection=document.getElementById("login-section"),this.cueBtn=document.getElementById("cue-btn"),this.releaseBtn=document.getElementById("release-btn"),this.resetBtn=document.getElementById("reset-btn"),this.gameStatus=document.getElementById("game-status"),this.playersList=document.getElementById("players"),this.gameStateIndicator=document.getElementById("game-state-indicator"),this.stateText=document.getElementById("state-text"),this.stateIcon=this.gameStateIndicator.querySelector(".state-icon"),this.networkLatencyIndicator=document.getElementById("network-latency-indicator"),this.latencyText=document.getElementById("latency-text"),this.chatMessages=document.getElementById("chat-messages"),this.chatInput=document.getElementById("chat-input"),this.chatSend=document.getElementById("chat-send"),this.joinBtn.addEventListener("click",(()=>this.joinGame())),this.cueBtn.addEventListener("click",(()=>this.takeCue())),this.releaseBtn.addEventListener("click",(()=>this.releaseCue())),this.resetBtn.addEventListener("click",(()=>this.resetTable())),this.chatSend.addEventListener("click",(()=>this.sendChatMessage())),this.chatInput.addEventListener("keypress",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendChatMessage())})),this.playerInput.addEventListener("keypress",(t=>{"Enter"===t.key&&(t.preventDefault(),this.joinGame())}))}setupSocket(){const t=X.getSocketUrl();this.socket=C(t,{withCredentials:!0,transports:["websocket"]}),this.socket.on("connect",(()=>{this.updateGameStatus(`已连接到服务器 (${X.isProduction?"生产环境":"本地开发"})`),this.updateGameStateIndicator("connected","已连接到服务器，请输入ID加入游戏")})),this.socket.on("disconnect",(()=>{this.updateGameStatus("与服务器断开连接"),this.updateGameStateIndicator("idle","与服务器断开连接"),this.clearHeartbeat(),this.stopLatencyMonitoring(),this.disableChat()})),this.socket.on("connect_error",(t=>{this.updateGameStatus(`连接失败: ${t.message}`),this.updateGameStateIndicator("idle",`连接失败: ${t.message}`)})),this.socket.on("joinGameResponse",(t=>{this.isJoining=!1,this.joinBtn.disabled=!1,t.success?(this.playerId=t.playerId,this.loginSection.style.display="none",this.gameControls.style.display="block",this.updateGameStatus(t.message),this.updateGameStateIndicator("waiting","目前无人持杆，可以拿起球杆开始游戏"),this.startHeartbeat(),this.startLatencyMonitoring(),this.enableChat()):(this.updateGameStatus(`加入失败: ${t.message}`),this.updateGameStateIndicator("idle",`加入失败: ${t.message}`),this.playerInput.value="",this.playerInput.focus())})),this.socket.on("chatHistory",(t=>{this.clearChatMessages(),t.forEach((t=>this.displayChatMessage(t))),this.scrollChatToBottom()})),this.socket.on("chatMessage",(t=>{this.displayChatMessage(t),this.scrollChatToBottom()})),this.socket.on("chatError",(t=>{this.displayChatMessage({type:"error",sender:"System",content:t.message,timestamp:(new Date).toISOString()}),this.scrollChatToBottom()})),this.socket.on("error",(t=>{this.updateGameStatus(`错误: ${t.message}`)})),this.socket.on("forceReleaseCue",(t=>{this.isHoldingCue=!1,this.updateCueButtons(!0),this.shotControls.style.display="none",this.directionArrow&&(this.directionArrow.visible=!1),this.updateGameStatus(`球杆已被释放: ${t.reason}`)})),this.socket.on("heartbeatResponse",(t=>{})),this.socket.on("pong",(t=>{const e=Date.now()-t.timestamp;this.updateNetworkLatency(e)})),this.socket.on("gameState",(t=>{this.updateGameState(t)})),this.socket.on("playerList",(t=>{this.updatePlayerList(t)})),this.socket.on("cueStateChanged",(t=>{this.updateCueState(t)})),this.socket.on("ballsUpdate",(t=>{t.playerId!==this.playerId&&this.poolTable&&Object.entries(t.state).forEach((([t,e])=>{this.poolTable.physics.setBallState(parseInt(t),e)}))})),this.socket.on("shotStart",(t=>{this.handleShotStart(t)})),this.socket.on("syncConfirm",(t=>{this.handleSyncConfirm(t)})),this.socket.on("simulationEnd",(t=>{this.handleSimulationEnd(t)})),this.socket.on("ballHit",(t=>{t.playerId!==this.playerId&&(this.poolTable.hitCueBall(t.force,t.direction,t.hitPoint),this.isSimulating=!0)})),this.socket.on("simulationComplete",(t=>{t.playerId!==this.playerId&&this.poolTable&&(Object.entries(t.finalState).forEach((([t,e])=>{this.poolTable.physics.setBallState(parseInt(t),e)})),this.isSimulating=!1,this.updateCueButtons(!0))})),this.socket.on("resetTable",(t=>{const{playerId:e,resetBy:i}=t;this.poolTable&&(this.poolTable.resetBalls(),this.isSimulating=!1,this.simulationStartTime&&(this.simulationStartTime=null),this.updateGameStatus(`${i} 重置了台球桌`),this.updateGameStateIndicator("waiting","台球桌已重置，等待确认..."),this.directionArrow&&(this.directionArrow.visible=!1),i===this.playerId&&(this.shotControls.style.display="none"))})),this.socket.on("playerScored",(t=>{const{playerId:e,ballNumber:i,pocketType:s,timestamp:n}=t;this.playerScores.has(e)||this.playerScores.set(e,[]),this.playerScores.get(e).push(i),this.updatePlayerListWithScores(),e===this.playerId?this.updateGameStatus(`🎯 你打进了球 ${i}！`):this.updateGameStatus(`🎯 ${e} 打进了球 ${i}`)})),this.socket.on("scoresCleared",(t=>{this.playerScores.clear(),this.updatePlayerListWithScores(),this.updateGameStatus("所有得分已清除")}))}startHeartbeat(){this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.heartbeatInterval=setInterval((()=>{this.socket&&this.socket.connected&&this.playerId&&this.socket.emit("heartbeat",{playerId:this.playerId})}),25e3)}clearHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}enableChat(){this.chatInput.disabled=!1,this.chatSend.disabled=!1,this.chatInput.placeholder="输入消息...",this.displayChatMessage({type:"system",sender:"System",content:"欢迎来到 IncrediPool！您可以在此与其他玩家聊天。",timestamp:(new Date).toISOString()})}disableChat(){this.chatInput.disabled=!0,this.chatSend.disabled=!0,this.chatInput.placeholder="请先加入游戏..."}sendChatMessage(){if(!this.playerId)return;const t=this.chatInput.value.trim();t&&(this.chatSend.disabled=!0,this.socket.emit("chatMessage",{playerId:this.playerId,content:t}),this.chatInput.value="",setTimeout((()=>{this.chatSend.disabled=!1}),2e3))}displayChatMessage(t){const e=document.createElement("div");e.className=`chat-message ${t.type}`;const i=new Date(t.timestamp).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"});"player"===t.type?e.innerHTML=`\n                <div class="chat-time">${i}</div>\n                <div class="chat-sender">${this.escapeHtml(t.sender)}:</div>\n                <div class="chat-content">${this.escapeHtml(t.content)}</div>\n            `:e.innerHTML=`\n                <div class="chat-time">${i}</div>\n                <div class="chat-content">${this.escapeHtml(t.content)}</div>\n            `,this.chatMessages.appendChild(e);const s=this.chatMessages.children;s.length>100&&this.chatMessages.removeChild(s[0])}clearChatMessages(){this.chatMessages.innerHTML=""}scrollChatToBottom(){setTimeout((()=>{this.chatMessages.scrollTop=this.chatMessages.scrollHeight}),50)}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}joinGame(){if(this.isJoining)return;const t=this.playerInput.value.trim();return t?t.length>20?(this.updateGameStatus("玩家ID不能超过20个字符"),void this.playerInput.focus()):(this.isJoining=!0,this.joinBtn.disabled=!0,this.updateGameStatus("正在加入游戏..."),this.updateGameStateIndicator("connecting","正在加入游戏..."),void this.socket.emit("joinGame",{playerId:t})):(this.updateGameStatus("请输入玩家ID"),void this.playerInput.focus())}takeCue(){this.playerId&&this.socket.emit("takeCue",{playerId:this.playerId})}releaseCue(){this.playerId&&this.socket.emit("releaseCue",{playerId:this.playerId})}resetTable(){this.socket&&this.socket.connected&&this.playerId&&(this.socket.emit("resetTable",{playerId:this.playerId}),this.updateGameStatus("正在重置球台..."),this.clearAllScores(),this.pendingOutOfBounds=[],this.pendingCueBallReset=!1,this.socket.emit("getPlayers"))}updateGameState(t){const{currentPlayer:e,isReset:i,readyForShot:s}=t;i&&s?e===this.playerId&&(this.updateGameStateIndicator("your-turn","台球桌已重置，可以开始击球了！"),this.updateCueButtons(!0),this.shotControls.style.display="block",this.directionArrow&&(this.directionArrow.visible=!0)):e?(this.updateGameStatus(`当前持杆玩家: ${e}`),e===this.playerId?(this.updateGameStateIndicator("your-turn","轮到你了！可以击球"),this.updateCueButtons(!0)):(this.updateGameStateIndicator("others-turn","",e),this.updateCueButtons(!1))):(this.updateGameStatus("等待玩家拿起球杆"),this.updateGameStateIndicator("waiting","目前无人持杆，可以拿起球杆开始游戏"),this.updateCueButtons(!0))}updatePlayerList(t){this.currentPlayers=t,this.updatePlayerListWithScores()}updateCueState(t){const{playerId:e,isHolding:i}=t;e===this.playerId?(this.isHoldingCue=i,this.updateCueButtons(i),i&&this.updateGameStateIndicator("your-turn","你正在持杆，调整参数后点击击球"),this.shotControls.style.display=i&&!this.isSimulating?"block":"none",this.directionArrow&&(this.directionArrow.visible=i&&!this.isSimulating)):i?this.updateGameStateIndicator("others-turn","",e):this.updateGameStateIndicator("waiting","目前无人持杆，可以拿起球杆开始游戏")}updateCueButtons(t){this.cueBtn.disabled=!t||this.isHoldingCue||this.isSimulating,this.releaseBtn.disabled=!this.isHoldingCue,this.resetBtn.disabled=!this.isHoldingCue||this.isSimulating}updateGameStatus(t){this.gameStatus.textContent=t}updateGameStateIndicator(t,e,i=null){if(!this.gameStateIndicator||!this.stateText||!this.stateIcon)return;this.gameStateIndicator.className="";let s="⏳",n=e;switch(t){case"connecting":this.gameStateIndicator.classList.add("idle"),s="🔌";break;case"connected":this.gameStateIndicator.classList.add("waiting"),s="✅";break;case"waiting":this.gameStateIndicator.classList.add("waiting"),s="⏳";break;case"your-turn":this.gameStateIndicator.classList.add("your-turn"),s="🎯";break;case"others-turn":this.gameStateIndicator.classList.add("others-turn"),s="👀",i&&(n=`${i} 正在持杆，等待击球`);break;case"simulating":this.gameStateIndicator.classList.add("simulating"),s="🎱";break;case"idle":this.gameStateIndicator.classList.add("idle"),s="💤";break;default:this.gameStateIndicator.classList.add("idle"),s="❓"}this.stateIcon.textContent=s,this.stateText.textContent=n}updateBallPositions(t){this.poolTable&&Object.entries(t).forEach((([t,e])=>{this.poolTable.updateBallPosition(parseInt(t),e)}))}setupDirectionIndicator(){if(!this.poolTable||!this.poolTable.balls)return void setTimeout((()=>this.setupDirectionIndicator()),100);const t=this.poolTable.balls.get(0);if(!t)return;const e=new E({color:5025616,transparent:!0,opacity:.7}),i=new u(.01,.01,.5,8);this.arrowBody=new h(i,e),this.arrowBody.position.y=.25;const s=new x(.03,.1,8);this.arrowHead=new h(s,e),this.arrowHead.position.y=.5,this.directionArrow=new I,this.directionArrow.add(this.arrowBody),this.directionArrow.add(this.arrowHead),this.directionArrow.position.copy(t.position),this.directionArrow.position.y+=.01,this.directionArrow.visible=!1,this.scene.add(this.directionArrow),this.updateDirectionArrow()}updateDirectionArrow(){if(!this.poolTable||!this.directionArrow)return;const t=this.poolTable.balls.get(0);if(!t)return;const i=Math.cos(this.verticalAngle),s=new e(Math.cos(this.shotDirection)*i,Math.sin(this.verticalAngle),Math.sin(this.shotDirection)*i);this.directionArrow.position.copy(t.position),this.directionArrow.position.y+=.01;this.directionArrow.position.x+=.029*this.hitPoint.x*.5,this.directionArrow.position.z+=.029*this.hitPoint.y*.5;const n=new e(0,1,0),a=new o;a.setFromUnitVectors(n,s),this.directionArrow.setRotationFromQuaternion(a);const r=.3+this.shotForce/10*.7;this.directionArrow.scale.set(r,r,r);const l=this.directionArrow.children[0].material;Math.abs(this.hitPoint.x)<.1&&Math.abs(this.hitPoint.y)<.1?l.color.setHex(5025616):Math.abs(this.hitPoint.y)>.5?l.color.setHex(2201331):Math.abs(this.hitPoint.x)>.5?l.color.setHex(16750592):l.color.setHex(10233776),this.directionArrow.visible=this.isHoldingCue&&!this.isSimulating}setupShotControls(){this.shotControls=document.getElementById("shot-controls"),this.horizontalSlider=document.getElementById("horizontal-slider"),this.horizontalFineSlider=document.getElementById("horizontal-fine-slider"),this.horizontalValue=document.getElementById("horizontal-value"),this.verticalSlider=document.getElementById("vertical-slider"),this.verticalFineSlider=document.getElementById("vertical-fine-slider"),this.verticalValue=document.getElementById("vertical-value"),this.hitPointControl=document.getElementById("hit-point-control"),this.hitPointHandle=document.getElementById("hit-point-handle"),this.hitPointXDisplay=document.getElementById("hit-point-x"),this.hitPointYDisplay=document.getElementById("hit-point-y"),this.forceSlider=document.getElementById("force-slider"),this.forceFineSlider=document.getElementById("force-fine-slider"),this.forceValue=document.getElementById("force-value"),this.shootButton=document.getElementById("shoot-button"),this.resetControlsButton=document.getElementById("reset-controls-button"),this.horizontalAngle=0,this.horizontalFineAdjust=0,this.verticalAngle=0,this.verticalFineAdjust=0,this.baseForce=5,this.forceFineAdjust=0,this.hitPoint={x:0,y:0},this.horizontalSlider.addEventListener("input",(t=>{this.horizontalAngle=parseFloat(t.target.value),this.updateHorizontalAngle()})),this.horizontalFineSlider.addEventListener("input",(t=>{this.horizontalFineAdjust=parseFloat(t.target.value),this.updateHorizontalAngle()})),this.verticalSlider.addEventListener("input",(t=>{this.verticalAngle=parseFloat(t.target.value),this.updateVerticalAngle()})),this.verticalFineSlider.addEventListener("input",(t=>{this.verticalFineAdjust=parseFloat(t.target.value),this.updateVerticalAngle()})),this.forceSlider.addEventListener("input",(t=>{this.baseForce=parseFloat(t.target.value),this.updateForce()})),this.forceFineSlider.addEventListener("input",(t=>{this.forceFineAdjust=parseFloat(t.target.value),this.updateForce()})),this.setupHitPointControl(),this.shootButton.addEventListener("click",(()=>this.executeShot())),this.resetControlsButton.addEventListener("click",(()=>this.resetShotControls())),this.updateAllDisplays()}updateHorizontalAngle(){const t=((this.horizontalAngle+this.horizontalFineAdjust)%360+360)%360;this.horizontalValue.textContent=`${t.toFixed(1)}°`,this.shotDirection=-t*Math.PI/180,this.updateDirectionArrow()}updateVerticalAngle(){const t=Math.max(0,Math.min(45,this.verticalAngle+this.verticalFineAdjust));this.verticalValue.textContent=`${t.toFixed(1)}°`,this.verticalAngle=t*Math.PI/180,this.updateDirectionArrow()}updateForce(){const t=Math.max(0,Math.min(10,this.baseForce+this.forceFineAdjust));this.forceValue.textContent=t.toFixed(2),this.shotForce=t,this.updateDirectionArrow()}setupHitPointControl(){let t=!1;const e=(e,i)=>{t=!0,this.updateHitPoint(e,i)},i=(e,i)=>{t&&this.updateHitPoint(e,i)},s=()=>{t=!1};this.hitPointControl.addEventListener("mousedown",(t=>{t.preventDefault(),e(t.clientX,t.clientY)})),document.addEventListener("mousemove",(e=>{t&&(e.preventDefault(),i(e.clientX,e.clientY))})),document.addEventListener("mouseup",(()=>{s()})),this.hitPointControl.addEventListener("touchstart",(t=>{t.preventDefault();const i=t.touches[0];e(i.clientX,i.clientY)})),document.addEventListener("touchmove",(e=>{if(t){e.preventDefault();const t=e.touches[0];i(t.clientX,t.clientY)}})),document.addEventListener("touchend",(()=>{s()})),this.hitPointControl.addEventListener("click",(e=>{t||this.updateHitPoint(e.clientX,e.clientY)}))}updateHitPoint(t,e){const i=this.hitPointControl.getBoundingClientRect(),s=i.left+i.width/2,n=i.top+i.height/2,o=Math.min(i.width,i.height)/2;let a=(t-s)/o,r=(e-n)/o;const l=Math.sqrt(a*a+r*r);l>1&&(a/=l,r/=l),this.hitPoint={x:a,y:r};const c=50+45*a,h=50+45*r;this.hitPointHandle.style.left=`${c}%`,this.hitPointHandle.style.top=`${h}%`,this.hitPointXDisplay.textContent=a.toFixed(2),this.hitPointYDisplay.textContent=r.toFixed(2)}resetShotControls(){this.horizontalSlider.value=0,this.horizontalFineSlider.value=0,this.horizontalAngle=0,this.horizontalFineAdjust=0,this.verticalSlider.value=0,this.verticalFineSlider.value=0,this.verticalAngle=0,this.verticalFineAdjust=0,this.forceSlider.value=5,this.forceFineSlider.value=0,this.baseForce=5,this.forceFineAdjust=0,this.hitPoint={x:0,y:0},this.hitPointHandle.style.left="50%",this.hitPointHandle.style.top="50%",this.updateAllDisplays(),this.updateDirectionArrow()}updateAllDisplays(){this.updateHorizontalAngle(),this.updateVerticalAngle(),this.updateForce(),this.hitPointXDisplay.textContent=this.hitPoint.x.toFixed(2),this.hitPointYDisplay.textContent=this.hitPoint.y.toFixed(2)}executeShot(){if(!this.isHoldingCue||this.isSimulating)return;const t=this.poolTable.physics.getBallsState(),i=Math.cos(this.verticalAngle),s=new e(Math.cos(this.shotDirection)*i,Math.sin(this.verticalAngle),Math.sin(this.shotDirection)*i),n={force:this.shotForce,direction:{x:s.x,y:s.y,z:s.z},hitPoint:this.hitPoint,timestamp:Date.now()},o={playerId:this.playerId,ballsState:t,shotData:n};this.networkStats.packetCount.sent++,this.networkStats.dataSize.shotStart=JSON.stringify(o).length,this.networkStats.shotStartTime=Date.now(),this.socket.emit("shotStart",o)}animate(t=0){requestAnimationFrame((t=>this.animate(t)));const e=(t-this.lastTime)/1e3;if(this.lastTime=t,this.poolTable&&this.isSimulating){const t=this.poolTable.update(e);t&&(t.pocketedBalls&&t.pocketedBalls.length>0&&(this.socket.emit("ballsPocketed",{playerId:this.playerId,pocketedBalls:t.pocketedBalls}),t.pocketedBalls.forEach((t=>{const{ballNumber:e,pocketType:i}=t;0===e&&(this.pendingCueBallReset=!0)}))),t.outOfBoundsBalls&&t.outOfBoundsBalls.length>0&&(this.pendingOutOfBounds=[...new Set([...this.pendingOutOfBounds,...t.outOfBoundsBalls])]),t.cueBallOutOfBounds&&(this.pendingCueBallReset=!0))}this.controls.update(),this.renderer.render(this.scene,this.camera)}handleSimulationEnd(t){const{playerId:e,message:i}=t;if(this.isSimulating=!1,this.pendingCueBallReset&&(this.poolTable.handleCueBallPocketed(),this.pendingCueBallReset=!1),this.pendingOutOfBounds.length>0&&(this.poolTable.resetOutOfBoundsBalls(this.pendingOutOfBounds),this.pendingOutOfBounds=[]),this.updateCueButtons(!0),this.updateGameStateIndicator("waiting",i),this.directionArrow&&(this.directionArrow.visible=!1),e===this.playerId&&this.poolTable){const t=this.poolTable.physics.getBallsState();this.socket.emit("simulationComplete",{playerId:this.playerId,finalState:t})}}handleShotStart(t){const{playerId:i,ballsState:s,shotData:n,startTime:o}=t;if(this.networkStats.shotStartTime){const t=Date.now()-this.networkStats.shotStartTime;this.networkStats.shotStartLatency.push(t)}this.networkStats.packetCount.received++,Object.entries(s).forEach((([t,e])=>{this.poolTable.physics.setBallState(parseInt(t),e)})),this.poolTable.balls.forEach(((t,e)=>{const i=this.poolTable.physics.bodies.get(e);i&&(t.position.copy(i.position),t.quaternion.copy(i.quaternion),t.visible=!0)}));const a=o?Math.max(0,o-Date.now()):50;setTimeout((()=>{const t=new e(n.direction.x,n.direction.y,n.direction.z);this.poolTable.hitCueBall(n.force,t,n.hitPoint),this.isSimulating=!0,this.updateGameStateIndicator("simulating","正在进行物理模拟，等待台球静止..."),this.directionArrow&&(this.directionArrow.visible=!1),this.simulationStartTime=Date.now()}),a)}handleSyncConfirm(t){const{authoritativeState:e,playerId:i,simulationMetrics:s}=t;if(this.simulationStartTime){const t=Date.now()-this.simulationStartTime;this.networkStats.syncLatency.push(t)}if(this.networkStats.packetCount.received++,this.networkStats.dataSize.syncConfirm=JSON.stringify(t).length,!e)return;const n=this.poolTable.physics.getBallsState(),o=this.performDetailedSyncCheck(n,e);this.handleSyncDifferences(o,e),this.logNetworkPerformance()}performDetailedSyncCheck(t,e){const i={maxPositionDiff:0,maxVelocityDiff:0,ballDifferences:{},overallScore:0,needsCorrection:!1};Object.keys(t).forEach((s=>{const n=t[s],o=e[s];if(n&&o){const t=Math.sqrt(Math.pow(n.position.x-o.position.x,2)+Math.pow(n.position.y-o.position.y,2)+Math.pow(n.position.z-o.position.z,2)),e=Math.sqrt(Math.pow(n.velocity.x-o.velocity.x,2)+Math.pow(n.velocity.y-o.velocity.y,2)+Math.pow(n.velocity.z-o.velocity.z,2));i.ballDifferences[s]={positionDiff:t,velocityDiff:e,needsPositionCorrection:t>.01,needsVelocityCorrection:e>.05},i.maxPositionDiff=Math.max(i.maxPositionDiff,t),i.maxVelocityDiff=Math.max(i.maxVelocityDiff,e)}}));const s=Math.max(0,100-1e3*i.maxPositionDiff),n=Math.max(0,100-200*i.maxVelocityDiff);return i.overallScore=(s+n)/2,i.needsCorrection=i.maxPositionDiff>.01||i.maxVelocityDiff>.05,i}handleSyncDifferences(t,e){t.needsCorrection&&(t.overallScore<80?this.applySmoothCorrection(e,t):this.applySelectiveCorrection(e,t),this.recordSyncMetrics(t))}applySmoothCorrection(t,e){let i=0;const s=Date.now(),n={};Object.keys(t).forEach((t=>{const e=this.poolTable.physics.bodies.get(parseInt(t));e&&(n[t]={position:e.position.clone(),velocity:e.velocity.clone(),quaternion:e.quaternion.clone()})}));const o=()=>{const e=Date.now()-s;i=Math.min(e/200,1);const a=this.easeOutCubic(i);Object.entries(t).forEach((([t,e])=>{const i=this.poolTable.physics.bodies.get(parseInt(t)),s=n[t];if(i&&s){i.position.x=this.lerp(s.position.x,e.position.x,a),i.position.y=this.lerp(s.position.y,e.position.y,a),i.position.z=this.lerp(s.position.z,e.position.z,a),i.velocity.x=this.lerp(s.velocity.x,e.velocity.x,a),i.velocity.y=this.lerp(s.velocity.y,e.velocity.y,a),i.velocity.z=this.lerp(s.velocity.z,e.velocity.z,a);const n=this.poolTable.balls.get(parseInt(t));n&&(n.position.copy(i.position),n.quaternion.copy(i.quaternion))}})),i<1&&requestAnimationFrame(o)};requestAnimationFrame(o)}applySelectiveCorrection(t,e){Object.entries(e.ballDifferences).forEach((([e,i])=>{if(i.needsPositionCorrection||i.needsVelocityCorrection){const i=this.poolTable.physics.bodies.get(parseInt(e)),s=t[e];if(i&&s){this.poolTable.physics.setBallState(parseInt(e),s);const t=this.poolTable.balls.get(parseInt(e));t&&(t.position.copy(i.position),t.quaternion.copy(i.quaternion))}}}))}recordSyncMetrics(t){if(this.syncMetrics||(this.syncMetrics={totalSyncs:0,totalScore:0,corrections:0,lastSync:null}),this.syncMetrics.totalSyncs++,this.syncMetrics.totalScore+=t.overallScore,t.needsCorrection&&this.syncMetrics.corrections++,this.syncMetrics.lastSync={score:t.overallScore,timestamp:Date.now(),maxDiff:t.maxPositionDiff},this.syncMetrics.totalSyncs%10==0){this.syncMetrics.totalScore,this.syncMetrics.totalSyncs,this.syncMetrics.corrections,this.syncMetrics.totalSyncs}}easeOutCubic(t){return 1-Math.pow(1-t,3)}lerp(t,e,i){return t+(e-t)*i}logNetworkPerformance(){const t=this.networkStats;if(t.shotStartLatency.length>0){t.shotStartLatency.reduce(((t,e)=>t+e),0),t.shotStartLatency.length,Math.max(...t.shotStartLatency),Math.min(...t.shotStartLatency)}if(t.syncLatency.length>0){t.syncLatency.reduce(((t,e)=>t+e),0),t.syncLatency.length,Math.max(...t.syncLatency)}let e=100;if(t.shotStartLatency.length>0){const i=t.shotStartLatency.reduce(((t,e)=>t+e),0)/t.shotStartLatency.length;e-=Math.min(i/2,30)}if(this.syncMetrics&&this.syncMetrics.totalSyncs>0){e-=20*(this.syncMetrics.corrections/this.syncMetrics.totalSyncs)}t.shotStartLatency.length>50&&(t.shotStartLatency=t.shotStartLatency.slice(-25)),t.syncLatency.length>50&&(t.syncLatency=t.syncLatency.slice(-25))}updateNetworkLatency(t){if(!this.networkLatencyIndicator||!this.latencyText)return;this.latencyStats.current=t,this.latencyStats.samples.push(t),this.latencyStats.samples.length>10&&this.latencyStats.samples.shift(),this.latencyStats.average=this.latencyStats.samples.reduce(((t,e)=>t+e),0)/this.latencyStats.samples.length,this.latencyText.textContent=`延迟: ${Math.round(this.latencyStats.average)}ms`,this.networkLatencyIndicator.classList.remove("excellent","good","fair","poor");const e=this.latencyStats.average;e<50?this.networkLatencyIndicator.classList.add("excellent"):e<100?this.networkLatencyIndicator.classList.add("good"):e<200?this.networkLatencyIndicator.classList.add("fair"):this.networkLatencyIndicator.classList.add("poor")}startLatencyMonitoring(){this.latencyMonitoringInterval&&clearInterval(this.latencyMonitoringInterval),this.latencyMonitoringInterval=setInterval((()=>{this.socket&&this.socket.connected&&this.playerId&&(this.latencyStats.lastPingTime=Date.now(),this.socket.emit("ping",{timestamp:this.latencyStats.lastPingTime}))}),3e3)}stopLatencyMonitoring(){this.latencyMonitoringInterval&&(clearInterval(this.latencyMonitoringInterval),this.latencyMonitoringInterval=null)}updatePlayerListWithScores(){this.currentPlayers&&(this.playersList.innerHTML="",this.currentPlayers.forEach((t=>{const e=document.createElement("li"),i=this.playerScores.get(t.id)||[],s=i.length>0?` (${i.length}球)`:"";e.innerHTML=`\n                <span style="color: ${t.isHoldingCue?"#4CAF50":"white"}">\n                    ${t.id}${s}\n                </span>\n                ${i.length>0?`<br><small style="color: #ccc;">进球: ${i.join(", ")}</small>`:""}\n            `,this.playersList.appendChild(e)})))}clearAllScores(){this.socket&&this.socket.connected&&this.playerId&&this.socket.emit("clearScores",{playerId:this.playerId})}};
